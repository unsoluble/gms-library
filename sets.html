<html>

<head>
	<link type="text/css" rel="stylesheet" href="jquery.qtip.min.css" />
	<link href='https://fonts.googleapis.com/css?family=Open Sans' rel='stylesheet'>
	<link href='styles.css' rel='stylesheet'>
	<base target="_parent">
</head>

<body>
	<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
	<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/webfont/1/webfont.js"></script>
	<script type="text/javascript" src="jquery.qtip.min.js"></script>
	
	<script type="text/javascript">
	
		$(document).ready(function(){
		
		var url_string = window.location.href;
		var url = new URL(url_string);
		var tag = url.searchParams.get("tag");
		
			$.ajax({
				url: 'https://www.librarything.com/api_getdata.php?userid=unsoluble&key=2337767339&resultsets=books,bookreviews,booktags&reviewmax=500&tagList=NovelSet&max=100&showReviews=1&showTags=1',
				dataType: 'jsonp',
				success: function(result){
					var text = '<table>';
					var arr = $.map(result.books, function(el) { return el });
					
					console.log(result);
					
					function dynamicSort(property) {
						var sortOrder = 1;
						if(property[0] === "-") {
							sortOrder = -1;
							property = property.substr(1);
						}
						return function (a,b) {
							var result = (a[property] < b[property]) ? -1 : (a[property] > b[property]) ? 1 : 0;
							return result * sortOrder;
						}
					}
					
					arr.sort(dynamicSort("author_code"));
		
					for (i=0; i < arr.length; i++) {
						var searchTerms = encodeURI(arr[i].title);
						var searchQuery = "https://search.follettsoftware.com/metasearch/ui/27293/search/books?requestId=new&currentSearchTypeId=ALL&q=" + searchTerms + "&resultsSortBy=MOSTRECENT"
						text += '<tr>';
						text += '<td><div class="book"><a href="' + searchQuery + '"><img class="cover" src="' + arr[i].cover + '" /></a></div></td>';
						text += '<td>' + arr[i].title + '</td>';
						text += '<td>' + arr[i].author_fl + '</td>';
						text += '<td>' + arr[i].copies + '</td>';
						text += '<td>' + arr[i].bookreview + '</td>';
						text += '</tr>';
					}
					
					text += '</table>';
					
					$('#books').html(text);
				}
			});
		});
		
	</script>
	
	<div id="books"></div>
	
</body>
</html>